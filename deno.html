<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Denomination</title>
    <link rel="icon" type="image/x-icon" href="favicon.png">

    <style>
    /* Top line spanning the width of the page */
    .top-line {
        background-color: #002B5B; /* Dark blue */
        height: 50px;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        z-index: 1000; /* To make sure it's always on top */
    }
  
    /* Menu button in top line */
    .menu {
        cursor: pointer;
        color: white;
        font-size: 20px;
    }
  
    /* Custom Settings button with '︙' symbol */
    .settings-btn {
        cursor: pointer;
        background-color: transparent;
        color: white;
        padding: 10px;
        border-radius: 80%;
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 22px; /* Adjust size of the dots */
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.3);
    }
  
    /* Dropdown Menu */
    .dropdown {
        display: none;
        background-color: #002B5B; /* Dark blue */
        padding: 10px;
        border: 1px solid #001f40;
        width: 250px;
        margin-top: 10px;
        border-radius: 5px;
        color: white;
        position: absolute;
        top: 50px; /* Position below the menu button */
        left: 20px; /* Align with the menu button */
    }
  
    .dropdown h4 {
        margin: 10px 0 5px;
        color: #ffffff;
    }
  
    .dropdown ul {
        list-style: none;
        padding-left: 20px;
        margin: 0 0 10px 0;
    }
  
    .dropdown ul li {
        margin: 4px 0;
        cursor: pointer;
        color: #d6e4ff;
    }
  
    .dropdown ul li:hover {
        text-decoration: underline;
    }
  
    /* Settings Menu */
    .settings-menu {
        position: absolute;
        top: 60px;
        right: 20px;
        background-color: #ffffff;
        color: #333;
        padding: 15px;
        width: 200px;
        border-radius: 5px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        display: none;
    }
  
    .settings-menu label {
        display: block;
        margin-bottom: 10px;
    }
  
    .settings-menu input {
        margin-right: 5px;
    }
  
    .settings-btn {
        cursor: pointer;
        background-color: transparent;
        color: white;
        padding: 10px;
        border-radius: 80%;
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 22px;
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.3);
        transition: background-color 0.3s; /* Smooth transition */
    }
  
    /* Add this rule for hover effect */
    .settings-btn:hover {
        background-color: #0056b3; /* Change to a lighter or contrasting blue */
    }
  
    .menu {
        cursor: pointer;
        color: white;
        font-size: 20px;
        padding: 10px;
        border-radius: 5px;
        transition: background-color 0.3s;
    }
  
    /* Hover effect for Menu */
    .menu:hover {
        background-color: #0056b3; /* Lighter or contrasting blue */
    }
  
    .dark-mode {
        background-color: #121212;
        color: #ffffff;
    }
  
    .dark-mode .menu {
        background-color: #333;
    }
  
    .dark-mode .dropdown {
        background-color: #333;
        border: 1px solid #444;
    }
  
    .dark-mode .settings-btn {
        background-color: #444;
    }  

    body {
        background-color: #D3D3D3;
        color: #333;
        font-family: Arial, sans-serif;
        margin: 10px;
        line-height: 1.0;
        padding-top: 60px; /* Add padding to account for fixed header */
    }

    .header {
        text-align: center;
        margin-top: 5px;
        margin-bottom: 1px;
        line-height: 1.0;
    }
    
    .main-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }
    
    .input-column {
        flex: 1;
        min-width: 400px;
        border: 2px solid #ddd;
        padding: 15px;
        border-radius: 4px;
        background-color: white;
    }
    
    .result-column {
        flex: 1;
        min-width: 400px;
        border: 2px solid #ddd;
        padding: 15px;
        border-radius: 4px;
        background-color: white;
    }
    
    .section {
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
    }
    
    .section h3 {
        margin: 3px 0;
        color: #333;
        font-size: 16px;
        line-height: 1.0;
    }
    
    .input-group {
        margin-bottom: 10px;
        line-height: 1.2;
    }
    
    .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        font-size: 15px;
    }
    
    .input-group input, .input-group select {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        border: 1px solid #ddd;
        border-radius: 3px;
        font-size: 14px;
    }
    
    button {
        background-color: #4CAF50;
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        margin-top: 8px;
        font-size: 14px;
    }
    
    button:hover {
        background-color: #45a049;
    }
    
    .denomination-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
        font-size: 12px;
    }
    
    .denomination-table th, .denomination-table td {
        border: 1px solid #ddd;
        padding: 5px;
        text-align: left;
    }
    
    .denomination-table th {
        background-color: #f2f2f2;
        line-height: 1.0;
    }
    
    .payment-method {
        margin-top: 10px;
        line-height: 1.0;
    }
    
    .payment-entry {
        border: 1px solid #ddd;
        padding: 8px;
        margin-bottom: 8px;
        border-radius: 3px;
        font-size: 12px;
    }
    
    .summary-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
        font-size: 14px;
        line-height: 1.2;
    }
    
    .summary-table th, .summary-table td {
        border: 1px solid #ddd;
        padding: 5px;
        text-align: left;
    }
    
    .summary-table th {
        background-color: #f2f2f2;
    }
    
    .totals {
        margin-top: 10px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 5px;
        font-size: 14px;
        color: #002B5B;
        line-height: 1.2;
    }
    
    .action-btn {
        background-color: #f44336;
        padding: 4px 8px;
        margin-left: 4px;
        font-size: 12px;
    }
    
    .action-btn.edit {
        background-color: #2196F3;
    }
    
    .print-only {
        display: none;
    }
    
    .date-cell {
        width: auto;
        white-space: nowrap;
        padding-right: 10px;
        font-size: 14px;
        line-height: 1.0;
    }
    
    .date-input {
        width: auto;
    }
    
    .print-btn-container {
        width: 100%;
        text-align: right;
        margin-top: 20px;
        margin-bottom: 20px;
    }
    
    .voucher-entry {
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
    }
    
    @media print {
        body * {
            visibility: hidden;
            margin: 0;
            padding: 0;
        }
        .print-section, .print-section * {
            visibility: visible;
        }
        .print-section {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            font-size: 12px;
            line-height: 1.1;
        }
        .print-section h2, .print-section h3 {
            margin: 5px 0;
        }
        .print-section table {
            margin: 5px 0;
            font-size: 11px;
        }
        .print-section table th, 
        .print-section table td {
            padding: 3px;
        }
        .no-print {
            display: none !important;
        }
    }
    
    .about-btn {
        background-color: #4CAF50;
        color: white;
        padding: 10px 20px;
        border: none;
        max-width: 100px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }
    
    .about-btn:hover {
        background-color: #45a049;
    }

    /* Overlay styling */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .about-content {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        max-width: 500px;
        text-align: center;
        position: relative;
    }

    .close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        cursor: pointer;
        color: #555;
    }

    .close-btn:hover {
        color: #000;
    }

    /* Add these styles */
    .mode-selector {
        margin: 10px 0;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
    }

    .mode-selector label {
        margin-right: 15px;
        cursor: pointer;
    }

    /* Print styles */
    @media print {
        #printSection {
            display: block !important;
        }
        
        #printSection h2 {
            text-align: center;
            margin-bottom: 15px;
        }
        
        #printSection table {
            width: 100%;
            margin-bottom: 15px;
        }
        
        body * {
            visibility: hidden;
        }
        
        #printSection, #printSection * {
            visibility: visible;
        }
        
        #printSection {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
    }
    </style>
</head>
<body>
    <!-- Top Line with Menu and Custom Settings Icon -->
    <div class="top-line">
        <div class="menu" onclick="toggleMenu()">☰ Menu</div>
        <div class="settings-btn" onclick="toggleSettings()">︙</div> <!-- '︙' as Settings Icon -->
    </div>

    <!-- Dropdown Menu -->
    <div class="dropdown" id="menuDropdown">
        <div>
            <h4>Premium Calculator</h4>
            <ul>
                <li><a href="index.html" style="color: white; text-decoration: none;">Motor</a></li>
                <li><a href="property.html" style="color: white; text-decoration: none;">Property</a></li>
                <li>Marine (Coming Soon)</li>
            </ul>
        </div>
        <div>
            <h4>Cash Denomination</h4>
            <ul>
                <li><a href="deno.html" style="color: white; text-decoration: none;">Cash Denomination</a></li>
            </ul>
        </div>
        <div>
            <h4>Knowledge (Coming Soon)</h4>
            <ul>
                <li>Insurance</li>
                <li>Share</li>
                <li>SIP</li>
            </ul>
        </div>
        <div>
            <h4>Converter (Coming Soon)</h4>
            <ul>
                <li>Area converter</li>
                <li>Price converter</li>
                <li>Date converter</li>
            </ul>
        </div>
        <div>
            <button class="about-btn" onclick="showAbout()">About</button>
        </div>
    </div>

    <!-- Settings Menu -->
    <div class="settings-menu" id="settingsMenu">
        <label>
            <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()"> Dark Mode
        </label>
        <label>
            Font Size:
            <input type="range" id="fontSizeRange" min="12" max="24" value="16" oninput="changeFontSize()">
        </label>
    </div>
    
    <div id="aboutOverlay" class="overlay">
        <div class="about-content">
            <span class="close-btn" onclick="hideAbout()">&times;</span>
            <h2>Premium Calculator</h2> 
            <h2>Version 1.12</h2>
            <p>This is a premium calculator for motor insurance. It calculates the premium based on various parameters such as vehicle type, value, cubic capacity, and additional options.</p>
            <h3>"""""""""""""""</h3>
            <h4>Developed by Nisheda Bhattarai</h4>
            <p>Email: nisheda@walla.com</p>
        </div>
    </div>

    <div class="header">
        <h1>Cash Denomination</h1>
        <div class="input-group">
            <table>
                <tr>
                    <td class="date-cell"><strong>Date:</strong></td>
                    <td><input type="date" id="currentDate" name="currentDate" class="date-input"></td>
                </tr>
            </table>
        </div>
        <div class="mode-selector">
            <label><input type="radio" name="mode" value="cash" checked onclick="toggleMode('cash')"> Cash Denomination</label>
            <label><input type="radio" name="mode" value="voucher" onclick="toggleMode('voucher')"> Voucher Entry</label>
        </div>
    </div>

    <div class="main-container">
        <!-- Input Column -->
        <div class="input-column">
            <!-- Cash Denomination Mode -->
            <div id="cashMode">
                <div class="section">
                    <h3>Cash Denomination</h3>
                    <button id="addPaymentDetails" class="no-print">Add Payment Details</button>
                    <div id="cashDenomination" style="display: none; margin-top: 8px;">
                        <table class="denomination-table">
                            <tr>
                                <th>Denomination</th>
                                <th>Count</th>
                                <th>Total</th>
                            </tr>
                            <tr>
                                <td>1000</td>
                                <td><input type="number" id="count1000" min="0" class="denomination-count"></td>
                                <td id="total1000">0</td>
                            </tr>
                            <tr>
                                <td>500</td>
                                <td><input type="number" id="count500" min="0" class="denomination-count"></td>
                                <td id="total500">0</td>
                            </tr>
                            <tr>
                                <td>100</td>
                                <td><input type="number" id="count100" min="0" class="denomination-count"></td>
                                <td id="total100">0</td>
                            </tr>
                            <tr>
                                <td>50</td>
                                <td><input type="number" id="count50" min="0" class="denomination-count"></td>
                                <td id="total50">0</td>
                            </tr>
                            <tr>
                                <td>20</td>
                                <td><input type="number" id="count20" min="0" class="denomination-count"></td>
                                <td id="total20">0</td>
                            </tr>
                            <tr>
                                <td>10</td>
                                <td><input type="number" id="count10" min="0" class="denomination-count"></td>
                                <td id="total10">0</td>
                            </tr>
                            <tr>
                                <td>5</td>
                                <td><input type="number" id="count5" min="0" class="denomination-count"></td>
                                <td id="total5">0</td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td><input type="number" id="count2" min="0" class="denomination-count"></td>
                                <td id="total2">0</td>
                            </tr>
                            <tr>
                                <td>1</td>
                                <td><input type="number" id="count1" min="0" class="denomination-count"></td>
                                <td id="total1">0</td>
                            </tr>
                            <tr>
                                <td colspan="2"><strong>Total Cash Counted</strong></td>
                                <td id="totalCashAmount">0</td>
                            </tr>
                        </table>
                        <div class="input-group">
                            <label for="toDepositAmount">Amount to Deposit:</label>
                            <input type="number" id="toDepositAmount" name="toDepositAmount" min="0" step="0.01">
                        </div>
                        <div class="totals">
                            <p><strong>Total Cash Counted:</strong> NPR <span id="totalCashCounted">0.00</span></p>
                            <p><strong>Difference:</strong> NPR <span id="cashDifferenceAmount">0.00</span></p>
                        </div>
                        <button id="saveCashPayment" class="no-print">Save Payment</button>
                    </div>
                </div>
            </div>
            
            <!-- Voucher Entry Mode -->
            <div id="voucherMode" style="display: none;">
                <div id="voucherEntries">
                    <!-- Voucher entries will be added here dynamically -->
                </div>
                <button id="addNewVoucherBtn" class="no-print">Add Voucher</button>

                <div class="section">
                    <h3>Payment Entry</h3>
                    <div class="payment-method">
                        <label><input type="checkbox" id="cashCheckbox" name="paymentMethod" value="cash"> Cash</label>
                        <label><input type="checkbox" id="chequeCheckbox" name="paymentMethod" value="cheque"> Cheque</label>
                        <label><input type="checkbox" id="onlineCheckbox" name="paymentMethod" value="online"> Online</label>
                        <label><input type="checkbox" id="creditCheckbox" name="paymentMethod" value="credit"> Credit</label>
                    </div>

                    <!-- Cash Payment -->
                    <div id="cashPayment" class="payment-entry" style="display: none;">
                        <h4>Cash Payment</h4>
                        <button id="addCashPaymentDetails" class="no-print">Add Payment Details</button>
                        <div id="voucherCashDenomination" style="display: none; margin-top: 8px;">
                            <table class="denomination-table">
                                <tr>
                                    <th>Denomination</th>
                                    <th>Count</th>
                                    <th>Total</th>
                                </tr>
                                <tr>
                                    <td>1000</td>
                                    <td><input type="number" id="voucherCount1000" min="0" class="denomination-count"></td>
                                    <td id="voucherTotal1000">0</td>
                                </tr>
                                <tr>
                                    <td>500</td>
                                    <td><input type="number" id="voucherCount500" min="0" class="denomination-count"></td>
                                    <td id="voucherTotal500">0</td>
                                </tr>
                                <tr>
                                    <td>100</td>
                                    <td><input type="number" id="voucherCount100" min="0" class="denomination-count"></td>
                                    <td id="voucherTotal100">0</td>
                                </tr>
                                <tr>
                                    <td>50</td>
                                    <td><input type="number" id="voucherCount50" min="0" class="denomination-count"></td>
                                    <td id="voucherTotal50">0</td>
                                </tr>
                                <tr>
                                    <td>20</td>
                                    <td><input type="number" id="voucherCount20" min="0" class="denomination-count"></td>
                                    <td id="voucherTotal20">0</td>
                                </tr>
                                <tr>
                                    <td>10</td>
                                    <td><input type="number" id="voucherCount10" min="0" class="denomination-count"></td>
                                    <td id="voucherTotal10">0</td>
                                </tr>
                                <tr>
                                    <td>5</td>
                                    <td><input type="number" id="voucherCount5" min="0" class="denomination-count"></td>
                                    <td id="voucherTotal5">0</td>
                                </tr>
                                <tr>
                                    <td>2</td>
                                    <td><input type="number" id="voucherCount2" min="0" class="denomination-count"></td>
                                    <td id="voucherTotal2">0</td>
                                </tr>
                                <tr>
                                    <td>1</td>
                                    <td><input type="number" id="voucherCount1" min="0" class="denomination-count"></td>
                                    <td id="voucherTotal1">0</td>
                                </tr>
                                <tr>
                                    <td colspan="2"><strong>Total Cash</strong></td>
                                    <td id="voucherTotalCashAmount">0</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Cheque Payment -->
                    <div id="chequePayment" class="payment-entry" style="display: none;">
                        <h4>Cheque Payment</h4>
                        <button id="addChequeBtn" class="no-print">Add Cheque Details</button>
                        <div id="chequeEntries">
                            <!-- Cheque entries will be added here dynamically -->
                        </div>
                    </div>

                    <!-- Online Payment -->
                    <div id="onlinePayment" class="payment-entry" style="display: none;">
                        <h4>Online Payment</h4>
                        <button id="addOnlineBtn" class="no-print">Add Online Details</button>
                        <div id="onlineEntries">
                            <!-- Online entries will be added here dynamically -->
                        </div>
                    </div>

                    <!-- Credit Payment -->
                    <div id="creditPayment" class="payment-entry" style="display: none;">
                        <h4>Credit Payment</h4>
                        <button id="addCreditBtn" class="no-print">Add Credit Details</button>
                        <div id="creditEntries">
                            <!-- Credit entries will be added here dynamically -->
                        </div>
                    </div>
                    
                    <button id="saveVoucherPaymentBtn" class="no-print" style="display: none; margin-top: 15px;">Save Voucher & Payment</button>
                </div>
            </div>
        </div>

        <!-- Result Column -->
        <div class="result-column">
            <div class="section">
                <h3>Vouchers and Payments Summary</h3>
                <table class="summary-table" id="voucherPaymentSummary">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Voucher Amount</th>
                            <th colspan="4">Payment Methods</th>
                            <th>Difference</th>
                            <th class="no-print">Action</th>
                        </tr>
                        <tr>
                            <th></th>
                            <th></th>
                            <th>Cash</th>
                            <th>Cheque</th>
                            <th>Online</th>
                            <th>Credit</th>
                            <th></th>
                            <th class="no-print"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h3>Bill/Voucher Summary</h3>
                <table class="summary-table" id="voucherSummary">
                    <thead>
                        <tr>
                            <th>Voucher No.</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th class="no-print">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Vouchers will be added here dynamically -->
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h3>Payment Received Details</h3>
                <table class="summary-table" id="paymentReceivedDetails">
                    <thead>
                        <tr>
                            <th rowspan="2">Transaction No.</th>
                            <th colspan="4">Payment Method</th>
                            <th rowspan="2" class="no-print">Action</th>
                        </tr>
                        <tr>
                            <th>Cash</th>
                            <th>Cheque</th>
                            <th>Online</th>
                            <th>Credit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Payment received details will be added here dynamically -->
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h3>Cash Denomination Summary (Total)</h3>
                <div id="cashDenominationSummary">
                    <!-- Total cash denomination will be shown here -->
                </div>
            </div>

            <div class="totals">
                <h3>Payment Method Totals</h3>
                <div id="paymentMethodTotals">
                    <p>Cash: NPR <span id="totalCashSummary">0.00</span></p>
                    <p>Cheque: NPR <span id="totalChequeSummary">0.00</span></p>
                    <p>Online: NPR <span id="totalOnlineSummary">0.00</span></p>
                    <p>Credit: NPR <span id="totalCreditSummary">0.00</span></p>
                </div>
                <p><strong>Total Vouchers Amount:</strong> NPR <span id="totalVouchersAmount">0.00</span></p>
                <p><strong>Total Payment Amount:</strong> NPR <span id="totalPaymentAmount">0.00</span></p>
                <p><strong>Difference Amount:</strong> NPR <span id="differenceAmount">0.00</span></p>
            </div>
            
            <div class="print-btn-container">
                <button class="no-print" onclick="preparePrintData()">Print Report</button>
            </div>
        </div>
    </div>

    <!-- Print Preview Section -->
    <div id="printSection" class="print-only print-section" style="display: none;">
        <h2>Cash Denomination</h2>
        <p><strong>Date:</strong> <span id="printDate"></span></p>
        
        <h3>Bill/Voucher Summary</h3>
        <table class="summary-table" id="printVoucherSummary">
            <thead>
                <tr>
                    <th>Voucher No.</th>
                    <th>Description</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                <!-- Vouchers will be added here for printing -->
            </tbody>
        </table>
        
        <h3>Payment Received Details</h3>
        <table class="summary-table" id="printPaymentReceivedDetails">
            <thead>
                <tr>
                    <th rowspan="2">Transaction No.</th>
                    <th colspan="4">Payment Method</th>
                </tr>
                <tr>
                    <th>Cash</th>
                    <th>Cheque</th>
                    <th>Online</th>
                    <th>Credit</th>
                </tr>
            </thead>
            <tbody>
                <!-- Payment details will be added here for printing -->
            </tbody>
        </table>
        
        <h3>Cash Denomination Summary (Total)</h3>
        <div id="printCashDenominationSummary">
            <!-- Total cash denomination will be shown here for printing -->
        </div>
        
        <div class="totals">
            <h3>Payment Details</h3>
            <p>Cash: NPR <span id="printTotalCashSummary">0.00</span></p>
            <p>Cheque: NPR <span id="printTotalChequeSummary">0.00</span></p>
            <p>Online: NPR <span id="printTotalOnlineSummary">0.00</span></p>
            <p>Credit: NPR <span id="printTotalCreditSummary">0.00</span></p>
            <p><strong>Total Vouchers Amount:</strong> NPR <span id="printTotalVouchersAmount">0.00</span></p>
            <p><strong>Total Payment Amount:</strong> NPR <span id="printTotalPaymentAmount">0.00</span></p>
            <p><strong>Difference Amount:</strong> NPR <span id="printDifferenceAmount">0.00</span></p>
        </div>
    </div>

    <script>
        // Global variables
        let transactions = [];
        let cashDenominations = [];
        let currentTransactionId = 1;
        let vouchers = [];
        let editingVoucher = null;
        let editingTransaction = null;
        let currentMode = 'cash';
        let pendingVouchers = [];
        let pendingTransaction = null;
        const STORAGE_KEY = 'cashDenominationData';

        // Set current date
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            document.getElementById('currentDate').value = dateString;
            document.getElementById('printDate').textContent = formatDateForPrint(today);
            
            // Initialize event listeners
            document.getElementById('addNewVoucherBtn').addEventListener('click', addNewVoucherEntry);
            document.getElementById('toDepositAmount').addEventListener('input', calculateDenomination);
            document.getElementById('saveVoucherPaymentBtn').addEventListener('click', saveVoucherPayment);

            // Payment method checkboxes
            const paymentCheckboxes = document.querySelectorAll('input[name="paymentMethod"]');
            paymentCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const paymentDiv = document.getElementById(`${this.value}Payment`);
                    paymentDiv.style.display = this.checked ? 'block' : 'none';
                });
            });

            // Cash denomination calculation
            const denominationInputs = document.querySelectorAll('.denomination-count');
            denominationInputs.forEach(input => {
                input.addEventListener('input', calculateDenomination);
            });

            // Add Payment Details button
            document.getElementById('addPaymentDetails').addEventListener('click', function() {
                const cashDenomination = document.getElementById('cashDenomination');
                cashDenomination.style.display = cashDenomination.style.display === 'none' ? 'block' : 'none';
                document.getElementById('saveCashPayment').style.display = 'block';
            });
            
            // Add Cash Payment Details button for voucher mode
            document.getElementById('addCashPaymentDetails').addEventListener('click', function() {
                const cashDenomination = document.getElementById('voucherCashDenomination');
                cashDenomination.style.display = cashDenomination.style.display === 'none' ? 'block' : 'none';
            });

            // Save Cash Payment button
            document.getElementById('saveCashPayment').addEventListener('click', saveCashPayment);

            // Add Cheque button
            document.getElementById('addChequeBtn').addEventListener('click', addChequeEntry);

            // Add Online button
            document.getElementById('addOnlineBtn').addEventListener('click', addOnlineEntry);

            // Add Credit button
            document.getElementById('addCreditBtn').addEventListener('click', addCreditEntry);
            
            // Load any saved data
            loadData();
        });

        function toggleMenu() {
            const dropdown = document.getElementById("menuDropdown");
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        }
  
        function toggleSettings() {
            const settingsMenu = document.getElementById("settingsMenu");
            settingsMenu.style.display = settingsMenu.style.display === "block" ? "none" : "block";
        }
  
        function toggleDarkMode() {
            const body = document.body;
            const darkModeCheckbox = document.getElementById("darkModeToggle");
    
            if (darkModeCheckbox.checked) {
                body.classList.add("dark-mode");
            } else {
                body.classList.remove("dark-mode");
            }
        }

        function changeFontSize() {
            const fontSize = document.getElementById("fontSizeRange").value;
            document.body.style.fontSize = fontSize + "px";
        }  

        function showAbout() {
            document.getElementById('aboutOverlay').style.display = 'flex';
        }

        function hideAbout() {
            document.getElementById('aboutOverlay').style.display = 'none';
        }

        // Close overlay when clicking outside the content
        window.onclick = function(event) {
            const overlay = document.getElementById('aboutOverlay');
            if (event.target == overlay) {
                overlay.style.display = 'none';
            }
        }

        function formatDateForPrint(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function padNumber(num) {
            return num.toString().padStart(3, '0');
        }

        function calculateDenomination() {
            const denominations = [1000, 500, 100, 50, 20, 10, 5, 2, 1];
            let totalCash = 0;

            denominations.forEach(denomination => {
                let countInput, totalElement;
                
                if (currentMode === 'cash') {
                    countInput = document.getElementById(`count${denomination}`);
                    totalElement = document.getElementById(`total${denomination}`);
                } else {
                    countInput = document.getElementById(`voucherCount${denomination}`);
                    totalElement = document.getElementById(`voucherTotal${denomination}`);
                }
                
                const count = parseInt(countInput.value) || 0;
                const total = count * denomination;
                totalElement.textContent = total;
                totalCash += total;
            });

            if (currentMode === 'cash') {
                document.getElementById('totalCashAmount').textContent = totalCash.toFixed(2);
                document.getElementById('totalCashCounted').textContent = totalCash.toFixed(2);
                
                // Calculate difference
                const toDeposit = parseFloat(document.getElementById('toDepositAmount').value) || 0;
                const difference = totalCash - toDeposit;
                document.getElementById('cashDifferenceAmount').textContent = difference.toFixed(2);
            } else {
                document.getElementById('voucherTotalCashAmount').textContent = totalCash.toFixed(2);
            }
        }

        function addNewVoucherEntry() {
            const voucherEntryId = 'voucher-' + Date.now();
            const voucherEntry = document.createElement('div');
            voucherEntry.className = 'voucher-entry';
            voucherEntry.id = voucherEntryId;
            voucherEntry.innerHTML = `
                <div class="input-group">
                    <label for="voucherNumber-${voucherEntryId}">Voucher Number:</label>
                    <input type="text" id="voucherNumber-${voucherEntryId}" name="voucherNumber" required>
                </div>
                <div class="input-group">
                    <label for="description-${voucherEntryId}">Description:</label>
                    <input type="text" id="description-${voucherEntryId}" name="description">
                </div>
                <div class="input-group">
                    <label for="amount-${voucherEntryId}">Amount:</label>
                    <input type="number" id="amount-${voucherEntryId}" name="amount" min="0" step="0.01">
                </div>
                <button class="no-print" onclick="removeVoucherEntry('${voucherEntryId}')">Remove Voucher</button>
            `;
            
            document.getElementById('voucherEntries').appendChild(voucherEntry);
            document.getElementById('saveVoucherPaymentBtn').style.display = 'block';
        }

        function removeVoucherEntry(id) {
            if (confirm('Are you sure you want to remove this voucher?')) {
                const element = document.getElementById(id);
                if (element) {
                    element.remove();
                }
                
                // Hide save button if no vouchers left
                if (document.getElementById('voucherEntries').children.length === 0) {
                    document.getElementById('saveVoucherPaymentBtn').style.display = 'none';
                }
            }
        }

        function saveCashPayment() {
            const denominations = [1000, 500, 100, 50, 20, 10, 5, 2, 1];
            let cashDetails = [];
            let totalCash = 0;

            denominations.forEach(denomination => {
                const count = parseInt(document.getElementById(`count${denomination}`).value) || 0;
                if (count > 0) {
                    const total = count * denomination;
                    cashDetails.push({
                        denomination,
                        count,
                        total
                    });
                    totalCash += total;
                }
            });

            if (cashDetails.length === 0) {
                alert('Please enter at least one denomination');
                return;
            }

            const toDeposit = parseFloat(document.getElementById('toDepositAmount').value) || 0;
            
            const transaction = {
                id: `TXN-${padNumber(currentTransactionId)}`,
                type: 'cash',
                amount: totalCash,
                toDeposit,
                difference: toDeposit - totalCash,
                details: cashDetails,
                date: document.getElementById('currentDate').value
            };

            transactions.push(transaction);
            currentTransactionId++;
            cashDenominations = cashDenominations.concat(cashDetails);

            updatePaymentSummary();
            clearPaymentInputs('cash');
            saveData();
        }

        function saveVoucherPayment() {
            // Collect all voucher entries
            const voucherEntries = document.querySelectorAll('.voucher-entry');
            if (voucherEntries.length === 0) {
                alert('Please add at least one voucher');
                return;
            }
            
            // Validate payment methods
            const paymentMethods = [];
            if (document.getElementById('cashCheckbox').checked) {
                paymentMethods.push('cash');
            }
            if (document.getElementById('chequeCheckbox').checked) {
                paymentMethods.push('cheque');
            }
            if (document.getElementById('onlineCheckbox').checked) {
                paymentMethods.push('online');
            }
            if (document.getElementById('creditCheckbox').checked) {
                paymentMethods.push('credit');
            }
            
            if (paymentMethods.length === 0) {
                alert('Please select at least one payment method');
                return;
            }
            
            // Validate payment details for each method
            let paymentDetails = {};
            let totalPayment = 0;
            
            // Cash payment validation
            if (paymentMethods.includes('cash')) {
                const cashTotal = parseFloat(document.getElementById('voucherTotalCashAmount').textContent) || 0;
                if (cashTotal <= 0) {
                    alert('Please enter cash denomination details');
                    return;
                }
                paymentDetails.cash = cashTotal;
                totalPayment += cashTotal;
            }
            
            // Cheque payment validation
            if (paymentMethods.includes('cheque')) {
                const chequeEntries = document.querySelectorAll('#chequeEntries .payment-entry');
                if (chequeEntries.length === 0) {
                    alert('Please add at least one cheque entry');
                    return;
                }
                
                let chequeTotal = 0;
                chequeEntries.forEach(entry => {
                    const amount = parseFloat(entry.querySelector('.cheque-amount').value) || 0;
                    chequeTotal += amount;
                });
                paymentDetails.cheque = chequeTotal;
                totalPayment += chequeTotal;
            }
            
            // Online payment validation
            if (paymentMethods.includes('online')) {
                const onlineEntries = document.querySelectorAll('#onlineEntries .payment-entry');
                if (onlineEntries.length === 0) {
                    alert('Please add at least one online entry');
                    return;
                }
                
                let onlineTotal = 0;
                onlineEntries.forEach(entry => {
                    const amount = parseFloat(entry.querySelector('.online-amount').value) || 0;
                    onlineTotal += amount;
                });
                paymentDetails.online = onlineTotal;
                totalPayment += onlineTotal;
            }
            
            // Credit payment validation
            if (paymentMethods.includes('credit')) {
                const creditEntries = document.querySelectorAll('#creditEntries .payment-entry');
                if (creditEntries.length === 0) {
                    alert('Please add at least one credit entry');
                    return;
                }
                
                let creditTotal = 0;
                creditEntries.forEach(entry => {
                    const amount = parseFloat(entry.querySelector('.credit-amount').value) || 0;
                    creditTotal += amount;
                });
                paymentDetails.credit = creditTotal;
                totalPayment += creditTotal;
            }
            
            // Calculate total voucher amount
            let totalVouchers = 0;
            const newVouchers = [];
            
            voucherEntries.forEach(entry => {
                const voucherNumber = entry.querySelector('input[id^="voucherNumber-"]').value;
                const description = entry.querySelector('input[id^="description-"]').value;
                const amount = parseFloat(entry.querySelector('input[id^="amount-"]').value) || 0;
                
                if (!voucherNumber || isNaN(amount)) {
                    alert('Please enter valid voucher number and amount for all vouchers');
                    return;
                }
                
                // Check for duplicate voucher numbers
                if (vouchers.some(v => v.voucherNumber === voucherNumber) || 
                    newVouchers.some(v => v.voucherNumber === voucherNumber)) {
                    alert(`Voucher number ${voucherNumber} already exists`);
                    return;
                }
                
                totalVouchers += amount;
                newVouchers.push({
                    voucherNumber,
                    description,
                    amount
                });
            });
            
            // Create transaction
            const transactionId = `TXN-${padNumber(currentTransactionId)}`;
            currentTransactionId++;
            
            // Save cash denominations if cash payment was used
            if (paymentMethods.includes('cash')) {
                const denominations = [1000, 500, 100, 50, 20, 10, 5, 2, 1];
                let cashDetails = [];
                
                denominations.forEach(denomination => {
                    const count = parseInt(document.getElementById(`voucherCount${denomination}`).value) || 0;
                    if (count > 0) {
                        cashDetails.push({
                            denomination,
                            count,
                            total: count * denomination
                        });
                    }
                });
                
                cashDenominations = cashDenominations.concat(cashDetails);
                transactions.push({
                    id: transactionId,
                    type: 'cash',
                    amount: paymentDetails.cash,
                    details: cashDetails,
                    date: document.getElementById('currentDate').value
                });
            }
            
            // Save cheque payments if cheque payment was used
            if (paymentMethods.includes('cheque')) {
                const chequeEntries = document.querySelectorAll('#chequeEntries .payment-entry');
                
                chequeEntries.forEach(entry => {
                    const chequeNumber = entry.querySelector('.cheque-number').value;
                    const bank = entry.querySelector('.cheque-bank').value;
                    const amount = parseFloat(entry.querySelector('.cheque-amount').value) || 0;
                    
                    transactions.push({
                        id: transactionId,
                        type: 'cheque',
                        chequeNumber,
                        bank,
                        amount,
                        date: document.getElementById('currentDate').value
                    });
                });
            }
            
            // Save online payments if online payment was used
            if (paymentMethods.includes('online')) {
                const onlineEntries = document.querySelectorAll('#onlineEntries .payment-entry');
                
                onlineEntries.forEach(entry => {
                    const reference = entry.querySelector('.online-reference').value;
                    const gateway = entry.querySelector('.online-gateway').value;
                    const amount = parseFloat(entry.querySelector('.online-amount').value) || 0;
                    
                    transactions.push({
                        id: transactionId,
                        type: 'online',
                        reference,
                        gateway,
                        amount,
                        date: document.getElementById('currentDate').value
                    });
                });
            }
            
            // Save credit payments if credit payment was used
            if (paymentMethods.includes('credit')) {
                const creditEntries = document.querySelectorAll('#creditEntries .payment-entry');
                
                creditEntries.forEach(entry => {
                    const creditNumber = entry.querySelector('.credit-number').value;
                    const creditedBy = entry.querySelector('.credit-by').value;
                    const amount = parseFloat(entry.querySelector('.credit-amount').value) || 0;
                    
                    transactions.push({
                        id: transactionId,
                        type: 'credit',
                        creditNumber,
                        creditedBy,
                        amount,
                        date: document.getElementById('currentDate').value
                    });
                });
            }
            
            // Save vouchers with transaction ID
            newVouchers.forEach(voucher => {
                voucher.transactionId = transactionId;
                vouchers.push(voucher);
            });
            
            // Update displays
            updatePaymentSummary();
            updateVoucherSummary();
            updatePaymentReceivedDetails();
            updateCashDenominationSummary();
            updateTotals();
            
            // Clear inputs
            document.getElementById('voucherEntries').innerHTML = '';
            clearPaymentInputs('all');
            document.getElementById('saveVoucherPaymentBtn').style.display = 'none';
            
            // Save data
            saveData();
        }

        function addChequeEntry() {
            const chequeEntries = document.getElementById('chequeEntries');
            const entryDiv = document.createElement('div');
            entryDiv.className = 'payment-entry';
            entryDiv.innerHTML = `
                <div class="input-group">
                    <label>Cheque Number:</label>
                    <input type="text" class="cheque-number" required>
                </div>
                <div class="input-group">
                    <label>Bank:</label>
                    <input type="text" class="cheque-bank" required>
                </div>
                <div class="input-group">
                    <label>Amount:</label>
                    <input type="number" class="cheque-amount" min="0" step="0.01" required>
                </div>
                <button class="action-btn no-print" onclick="this.parentElement.remove()">Delete</button>
            `;
            chequeEntries.appendChild(entryDiv);
        }

        function addOnlineEntry() {
            const onlineEntries = document.getElementById('onlineEntries');
            const entryDiv = document.createElement('div');
            entryDiv.className = 'payment-entry';
            entryDiv.innerHTML = `
                <div class="input-group">
                    <label>Reference Number:</label>
                    <input type="text" class="online-reference" required>
                </div>
                <div class="input-group">
                    <label>Payment Gateway:</label>
                    <input type="text" class="online-gateway" required>
                </div>
                <div class="input-group">
                    <label>Amount:</label>
                    <input type="number" class="online-amount" min="0" step="0.01" required>
                </div>
                <button class="action-btn no-print" onclick="this.parentElement.remove()">Delete</button>
            `;
            onlineEntries.appendChild(entryDiv);
        }

        function addCreditEntry() {
            const creditEntries = document.getElementById('creditEntries');
            const entryDiv = document.createElement('div');
            entryDiv.className = 'payment-entry';
            entryDiv.innerHTML = `
                <div class="input-group">
                    <label>Credit Number:</label>
                    <input type="text" class="credit-number" required>
                </div>
                <div class="input-group">
                    <label>Credited By:</label>
                    <input type="text" class="credit-by" required>
                </div>
                <div class="input-group">
                    <label>Amount:</label>
                    <input type="number" class="credit-amount" min="0" step="0.01" required>
                </div>
                <button class="action-btn no-print" onclick="this.parentElement.remove()">Delete</button>
            `;
            creditEntries.appendChild(entryDiv);
        }

        function clearPaymentInputs(type) {
            if (type === 'cash') {
                document.querySelectorAll('.denomination-count').forEach(input => input.value = '');
                document.getElementById('cashDenomination').style.display = 'none';
                document.getElementById('saveCashPayment').style.display = 'none';
                document.getElementById('cashCheckbox').checked = false;
                document.getElementById('cashPayment').style.display = 'none';
            } else if (type === 'cheque') {
                document.getElementById('chequeEntries').innerHTML = '';
                document.getElementById('chequeCheckbox').checked = false;
                document.getElementById('chequePayment').style.display = 'none';
            } else if (type === 'online') {
                document.getElementById('onlineEntries').innerHTML = '';
                document.getElementById('onlineCheckbox').checked = false;
                document.getElementById('onlinePayment').style.display = 'none';
            } else if (type === 'credit') {
                document.getElementById('creditEntries').innerHTML = '';
                document.getElementById('creditCheckbox').checked = false;
                document.getElementById('creditPayment').style.display = 'none';
            } else if (type === 'all') {
                clearPaymentInputs('cash');
                clearPaymentInputs('cheque');
                clearPaymentInputs('online');
                clearPaymentInputs('credit');
            }
        }

        function updatePaymentSummary() {
            const tbody = document.querySelector('#voucherPaymentSummary tbody');
            tbody.innerHTML = '';

            // Group by transaction
            const transactionGroups = {};
            transactions.forEach(transaction => {
                if (!transactionGroups[transaction.id]) {
                    transactionGroups[transaction.id] = {
                        cash: 0,
                        cheque: 0,
                        online: 0,
                        credit: 0,
                        vouchers: []
                    };
                }

                switch (transaction.type) {
                    case 'cash':
                        transactionGroups[transaction.id].cash = transaction.amount;
                        break;
                    case 'cheque':
                        transactionGroups[transaction.id].cheque = transaction.amount;
                        break;
                    case 'online':
                        transactionGroups[transaction.id].online = transaction.amount;
                        break;
                    case 'credit':
                        transactionGroups[transaction.id].credit = transaction.amount;
                        break;
                }
            });

            // Associate vouchers with transactions
            vouchers.forEach(voucher => {
                if (voucher.transactionId && transactionGroups[voucher.transactionId]) {
                    transactionGroups[voucher.transactionId].vouchers.push(voucher);
                }
            });

            // Create rows
            Object.keys(transactionGroups).forEach(id => {
                const group = transactionGroups[id];
                const paymentTotal = group.cash + group.cheque + group.online + group.credit;
                const voucherTotal = group.vouchers.reduce((sum, v) => sum + v.amount, 0);
                const difference = paymentTotal - voucherTotal;

                // Add a row for each voucher
                group.vouchers.forEach((voucher, index) => {
                    const row = document.createElement('tr');
                    
                    // Only show payment methods in first row for this transaction
                    const paymentCells = index === 0 ? `
                        <td rowspan="${group.vouchers.length}">${group.cash.toFixed(2)}</td>
                        <td rowspan="${group.vouchers.length}">${group.cheque.toFixed(2)}</td>
                        <td rowspan="${group.vouchers.length}">${group.online.toFixed(2)}</td>
                        <td rowspan="${group.vouchers.length}">${group.credit.toFixed(2)}</td>
                        <td rowspan="${group.vouchers.length}">${difference.toFixed(2)}</td>
                        <td rowspan="${group.vouchers.length}" class="no-print">
                            <button class="action-btn edit" onclick="editTransaction('${id}')">Edit</button>
                            <button class="action-btn" onclick="deleteTransaction('${id}')">Delete</button>
                        </td>
                    ` : `
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="no-print"></td>
                    `;

                    row.innerHTML = `
                        <td>${voucher.description}</td>
                        <td>${voucher.amount.toFixed(2)}</td>
                        ${paymentCells}
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        function updateVoucherSummary() {
            const tbody = document.querySelector('#voucherSummary tbody');
            tbody.innerHTML = '';

            vouchers.forEach(voucher => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${voucher.voucherNumber}</td>
                    <td>${voucher.description}</td>
                    <td>${voucher.amount.toFixed(2)}</td>
                    <td class="no-print">
                        <button class="action-btn edit" onclick="editVoucher('${voucher.voucherNumber}')">Edit</button>
                        <button class="action-btn" onclick="deleteVoucher('${voucher.voucherNumber}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updatePaymentReceivedDetails() {
            const tbody = document.querySelector('#paymentReceivedDetails tbody');
            tbody.innerHTML = '';

            // Group transactions by ID
            const transactionGroups = {};
            transactions.forEach(transaction => {
                if (!transactionGroups[transaction.id]) {
                    transactionGroups[transaction.id] = {
                        cash: 0,
                        cheque: 0,
                        online: 0,
                        credit: 0
                    };
                }

                switch (transaction.type) {
                    case 'cash':
                        transactionGroups[transaction.id].cash = transaction.amount;
                        break;
                    case 'cheque':
                        transactionGroups[transaction.id].cheque = transaction.amount;
                        break;
                    case 'online':
                        transactionGroups[transaction.id].online = transaction.amount;
                        break;
                    case 'credit':
                        transactionGroups[transaction.id].credit = transaction.amount;
                        break;
                }
            });

            // Add rows for each transaction
            Object.keys(transactionGroups).forEach(id => {
                const group = transactionGroups[id];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>[${id.split('-')[1]}]</td>
                    <td>${group.cash ? group.cash.toFixed(2) : '-'}</td>
                    <td>${group.cheque ? group.cheque.toFixed(2) : '-'}</td>
                    <td>${group.online ? group.online.toFixed(2) : '-'}</td>
                    <td>${group.credit ? group.credit.toFixed(2) : '-'}</td>
                    <td class="no-print">
                        <button class="action-btn edit" onclick="editTransaction('${id}')">Edit</button>
                        <button class="action-btn" onclick="deleteTransaction('${id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateCashDenominationSummary() {
            const summaryDiv = document.getElementById('cashDenominationSummary');
            
            // Calculate totals for each denomination
            const denominationTotals = {};
            cashDenominations.forEach(d => {
                if (!denominationTotals[d.denomination]) {
                    denominationTotals[d.denomination] = { count: 0, total: 0 };
                }
                denominationTotals[d.denomination].count += d.count;
                denominationTotals[d.denomination].total += d.total;
            });

            // Sort denominations from highest to lowest
            const sortedDenominations = Object.keys(denominationTotals).sort((a, b) => b - a);

            // Display totals
            let html = '<table class="denomination-table"><tr><th>Denomination</th><th>Count</th><th>Total</th></tr>';
            sortedDenominations.forEach(denomination => {
                const detail = denominationTotals[denomination];
                html += `<tr><td>${denomination}</td><td>${detail.count}</td><td>${detail.total.toFixed(2)}</td></tr>`;
            });
            html += '</table>';

            summaryDiv.innerHTML = html;
        }

        function editVoucher(voucherNumber) {
            const voucher = vouchers.find(v => v.voucherNumber === voucherNumber);
            if (!voucher) return;

            // Add a new voucher entry with the voucher details
            addNewVoucherEntry();
            const latestEntry = document.getElementById('voucherEntries').lastChild;
            
            latestEntry.querySelector('input[id^="voucherNumber-"]').value = voucher.voucherNumber;
            latestEntry.querySelector('input[id^="description-"]').value = voucher.description;
            latestEntry.querySelector('input[id^="amount-"]').value = voucher.amount;
            
            // Remove the original voucher
            vouchers = vouchers.filter(v => v.voucherNumber !== voucherNumber);
            
            // Update displays
            updateVoucherSummary();
            updatePaymentSummary();
            updateTotals();
            
            // Show save button
            document.getElementById('saveVoucherPaymentBtn').style.display = 'block';
        }

        function deleteVoucher(voucherNumber) {
            if (confirm('Are you sure you want to delete this voucher?')) {
                // Remove from array
                vouchers = vouchers.filter(v => v.voucherNumber !== voucherNumber);
                
                // Update displays
                updateVoucherSummary();
                updatePaymentSummary();
                updateTotals();
                
                // Save data
                saveData();
            }
        }

        function editTransaction(id) {
            // Find transaction to edit
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;

            // Set editing state
            editingTransaction = id;
            
            // Depending on type, populate the appropriate form
            switch (transaction.type) {
                case 'cash':
                    document.getElementById('cashCheckbox').checked = true;
                    document.getElementById('cashPayment').style.display = 'block';
                    
                    // Populate denomination inputs
                    transaction.details.forEach(detail => {
                        document.getElementById(`voucherCount${detail.denomination}`).value = detail.count;
                        document.getElementById(`voucherTotal${detail.denomination}`).textContent = detail.total;
                    });
                    document.getElementById('voucherTotalCashAmount').textContent = transaction.amount;
                    document.getElementById('voucherCashDenomination').style.display = 'block';
                    break;
                    
                case 'cheque':
                    document.getElementById('chequeCheckbox').checked = true;
                    document.getElementById('chequePayment').style.display = 'block';
                    
                    // Clear existing entries
                    document.getElementById('chequeEntries').innerHTML = '';
                    
                    // Add entry for this transaction
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'payment-entry';
                    entryDiv.innerHTML = `
                        <div class="input-group">
                            <label>Cheque Number:</label>
                            <input type="text" class="cheque-number" value="${transaction.chequeNumber}" required>
                        </div>
                        <div class="input-group">
                            <label>Bank:</label>
                            <input type="text" class="cheque-bank" value="${transaction.bank}" required>
                        </div>
                        <div class="input-group">
                            <label>Amount:</label>
                            <input type="number" class="cheque-amount" value="${transaction.amount}" min="0" step="0.01" required>
                        </div>
                        <button class="action-btn no-print" onclick="this.parentElement.remove()">Delete</button>
                    `;
                    document.getElementById('chequeEntries').appendChild(entryDiv);
                    break;
                    
                case 'online':
                    document.getElementById('onlineCheckbox').checked = true;
                    document.getElementById('onlinePayment').style.display = 'block';
                    
                    // Clear existing entries
                    document.getElementById('onlineEntries').innerHTML = '';
                    
                    // Add entry for this transaction
                    const onlineEntryDiv = document.createElement('div');
                    onlineEntryDiv.className = 'payment-entry';
                    onlineEntryDiv.innerHTML = `
                        <div class="input-group">
                            <label>Reference Number:</label>
                            <input type="text" class="online-reference" value="${transaction.reference}" required>
                        </div>
                        <div class="input-group">
                            <label>Payment Gateway:</label>
                            <input type="text" class="online-gateway" value="${transaction.gateway}" required>
                        </div>
                        <div class="input-group">
                            <label>Amount:</label>
                            <input type="number" class="online-amount" value="${transaction.amount}" min="0" step="0.01" required>
                        </div>
                        <button class="action-btn no-print" onclick="this.parentElement.remove()">Delete</button>
                    `;
                    document.getElementById('onlineEntries').appendChild(onlineEntryDiv);
                    break;
                    
                case 'credit':
                    document.getElementById('creditCheckbox').checked = true;
                    document.getElementById('creditPayment').style.display = 'block';
                    
                    // Clear existing entries
                    document.getElementById('creditEntries').innerHTML = '';
                    
                    // Add entry for this transaction
                    const creditEntryDiv = document.createElement('div');
                    creditEntryDiv.className = 'payment-entry';
                    creditEntryDiv.innerHTML = `
                        <div class="input-group">
                            <label>Credit Number:</label>
                            <input type="text" class="credit-number" value="${transaction.creditNumber}" required>
                        </div>
                        <div class="input-group">
                            <label>Credited By:</label>
                            <input type="text" class="credit-by" value="${transaction.creditedBy}" required>
                        </div>
                        <div class="input-group">
                            <label>Amount:</label>
                            <input type="number" class="credit-amount" value="${transaction.amount}" min="0" step="0.01" required>
                        </div>
                        <button class="action-btn no-print" onclick="this.parentElement.remove()">Delete</button>
                    `;
                    document.getElementById('creditEntries').appendChild(creditEntryDiv);
                    break;
            }
            
            // Add vouchers associated with this transaction
            const transactionVouchers = vouchers.filter(v => v.transactionId === id);
            document.getElementById('voucherEntries').innerHTML = '';
            
            transactionVouchers.forEach(voucher => {
                addNewVoucherEntry();
                const latestEntry = document.getElementById('voucherEntries').lastChild;
                
                latestEntry.querySelector('input[id^="voucherNumber-"]').value = voucher.voucherNumber;
                latestEntry.querySelector('input[id^="description-"]').value = voucher.description;
                latestEntry.querySelector('input[id^="amount-"]').value = voucher.amount;
            });
            
            // Remove the original transaction and vouchers
            transactions = transactions.filter(t => t.id !== id);
            vouchers = vouchers.filter(v => v.transactionId !== id);
            
            // Show save button
            document.getElementById('saveVoucherPaymentBtn').style.display = 'block';
        }

        function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                // Remove from transactions array
                const deletedTransaction = transactions.find(t => t.id === id);
                transactions = transactions.filter(t => t.id !== id);
                
                // If it was a cash transaction, remove from cashDenominations
                if (deletedTransaction && deletedTransaction.type === 'cash') {
                    cashDenominations = cashDenominations.filter(d => 
                        !deletedTransaction.details.some(detail => 
                            detail.denomination === d.denomination && 
                            detail.count === d.count && 
                            detail.total === d.total
                        )
                    );
                }
                
                // Remove associated vouchers
                vouchers = vouchers.filter(v => v.transactionId !== id);
                
                // Update displays
                updatePaymentSummary();
                updateVoucherSummary();
                updatePaymentReceivedDetails();
                updateCashDenominationSummary();
                updateTotals();
                
                // Save data
                saveData();
            }
        }

        function updateTotals() {
            // Calculate total vouchers amount
            let totalVouchers = vouchers.reduce((sum, voucher) => sum + voucher.amount, 0);
            document.getElementById('totalVouchersAmount').textContent = totalVouchers.toFixed(2);
            
            // Calculate payment method totals
            const totalCash = transactions
                .filter(t => t.type === 'cash')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalCheque = transactions
                .filter(t => t.type === 'cheque')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalOnline = transactions
                .filter(t => t.type === 'online')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalCredit = transactions
                .filter(t => t.type === 'credit')
                .reduce((sum, t) => sum + t.amount, 0);
            
            document.getElementById('totalCashSummary').textContent = totalCash.toFixed(2);
            document.getElementById('totalChequeSummary').textContent = totalCheque.toFixed(2);
            document.getElementById('totalOnlineSummary').textContent = totalOnline.toFixed(2);
            document.getElementById('totalCreditSummary').textContent = totalCredit.toFixed(2);
            
            // Calculate total payment amount
            const totalPayment = totalCash + totalCheque + totalOnline + totalCredit;
            document.getElementById('totalPaymentAmount').textContent = totalPayment.toFixed(2);
            
            // Calculate difference
            const difference = totalPayment - totalVouchers;
            document.getElementById('differenceAmount').textContent = difference.toFixed(2);
        }

        function toggleMode(mode) {
            currentMode = mode;
            document.getElementById('cashMode').style.display = mode === 'cash' ? 'block' : 'none';
            document.getElementById('voucherMode').style.display = mode === 'voucher' ? 'block' : 'none';
        }

        function preparePrintData() {
            document.getElementById('printSection').innerHTML = `
                <h2>Cash Denomination</h2>
                <p><strong>Date:</strong> <span id="printDate"></span></p>
                <div id="printContent"></div>
            `;
        
            const today = new Date();
            document.getElementById('printDate').textContent = formatDateForPrint(today);
        
            const printContent = document.getElementById('printContent');
        
            // Print voucher summary
            const voucherHtml = `
                <h3>Bill/Voucher Summary</h3>
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Voucher No.</th>
                            <th>Description</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="printVoucherSummary">
                        <!-- Will be populated -->
                    </tbody>
                </table>
            `;
            printContent.innerHTML = voucherHtml;
            
            // Populate voucher summary for printing
            const printVoucherTbody = document.getElementById('printVoucherSummary');
            vouchers.forEach(voucher => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${voucher.voucherNumber}</td>
                    <td>${voucher.description}</td>
                    <td>${voucher.amount.toFixed(2)}</td>
                `;
                printVoucherTbody.appendChild(row);
            });
            
            // Print payment received details
            const paymentHtml = `
                <h3>Payment Received Details</h3>
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th rowspan="2">Transaction No.</th>
                            <th colspan="4">Payment Method</th>
                        </tr>
                        <tr>
                            <th>Cash</th>
                            <th>Cheque</th>
                            <th>Online</th>
                            <th>Credit</th>
                        </tr>
                    </thead>
                    <tbody id="printPaymentReceivedDetails">
                        <!-- Will be populated -->
                    </tbody>
                </table>
            `;
            printContent.innerHTML += paymentHtml;
            
            // Group transactions by ID for printing
            const transactionGroups = {};
            transactions.forEach(transaction => {
                if (!transactionGroups[transaction.id]) {
                    transactionGroups[transaction.id] = {
                        cash: 0,
                        cheque: 0,
                        online: 0,
                        credit: 0
                    };
                }

                switch (transaction.type) {
                    case 'cash':
                        transactionGroups[transaction.id].cash = transaction.amount;
                        break;
                    case 'cheque':
                        transactionGroups[transaction.id].cheque = transaction.amount;
                        break;
                    case 'online':
                        transactionGroups[transaction.id].online = transaction.amount;
                        break;
                    case 'credit':
                        transactionGroups[transaction.id].credit = transaction.amount;
                        break;
                }
            });

            // Add rows for printing
            const printPaymentTbody = document.getElementById('printPaymentReceivedDetails');
            Object.keys(transactionGroups).forEach(id => {
                const group = transactionGroups[id];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>[${id.split('-')[1]}]</td>
                    <td>${group.cash ? group.cash.toFixed(2) : '-'}</td>
                    <td>${group.cheque ? group.cheque.toFixed(2) : '-'}</td>
                    <td>${group.online ? group.online.toFixed(2) : '-'}</td>
                    <td>${group.credit ? group.credit.toFixed(2) : '-'}</td>
                `;
                printPaymentTbody.appendChild(row);
            });
            
            // Print cash denomination summary if there are any cash transactions
            const hasCashTransactions = transactions.some(t => t.type === 'cash');
            if (hasCashTransactions) {
                const cashHtml = `
                    <h3>Cash Denomination Summary (Total)</h3>
                    <div id="printCashDenominationSummary">
                        <!-- Will be populated -->
                    </div>
                `;
                printContent.innerHTML += cashHtml;
                
                // Calculate totals for each denomination
                const denominationTotals = {};
                cashDenominations.forEach(d => {
                    if (!denominationTotals[d.denomination]) {
                        denominationTotals[d.denomination] = { count: 0, total: 0 };
                    }
                    denominationTotals[d.denomination].count += d.count;
                    denominationTotals[d.denomination].total += d.total;
                });

                // Sort denominations from highest to lowest
                const sortedDenominations = Object.keys(denominationTotals).sort((a, b) => b - a);

                // Display totals
                let html = '<table class="denomination-table"><tr><th>Denomination</th><th>Count</th><th>Total</th></tr>';
                sortedDenominations.forEach(denomination => {
                    const detail = denominationTotals[denomination];
                    html += `<tr><td>${denomination}</td><td>${detail.count}</td><td>${detail.total.toFixed(2)}</td></tr>`;
                });
                html += '</table>';

                document.getElementById('printCashDenominationSummary').innerHTML = html;
            }
            
            // Print totals
            const totalsHtml = `
                <div class="totals">
                    <h3>Payment Details</h3>
                    <p>Cash: NPR <span id="printTotalCashSummary">0.00</span></p>
                    <p>Cheque: NPR <span id="printTotalChequeSummary">0.00</span></p>
                    <p>Online: NPR <span id="printTotalOnlineSummary">0.00</span></p>
                    <p>Credit: NPR <span id="printTotalCreditSummary">0.00</span></p>
                    <p><strong>Total Vouchers Amount:</strong> NPR <span id="printTotalVouchersAmount">0.00</span></p>
                    <p><strong>Total Payment Amount:</strong> NPR <span id="printTotalPaymentAmount">0.00</span></p>
                    <p><strong>Difference Amount:</strong> NPR <span id="printDifferenceAmount">0.00</span></p>
                </div>
            `;
            printContent.innerHTML += totalsHtml;
            
            // Update print totals
            const totalVouchers = vouchers.reduce((sum, voucher) => sum + voucher.amount, 0);
            const totalCash = transactions.filter(t => t.type === 'cash').reduce((sum, t) => sum + t.amount, 0);
            const totalCheque = transactions.filter(t => t.type === 'cheque').reduce((sum, t) => sum + t.amount, 0);
            const totalOnline = transactions.filter(t => t.type === 'online').reduce((sum, t) => sum + t.amount, 0);
            const totalCredit = transactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
            const totalPayment = totalCash + totalCheque + totalOnline + totalCredit;
            const difference = totalPayment - totalVouchers;
            
            document.getElementById('printTotalVouchersAmount').textContent = totalVouchers.toFixed(2);
            document.getElementById('printTotalCashSummary').textContent = totalCash.toFixed(2);
            document.getElementById('printTotalChequeSummary').textContent = totalCheque.toFixed(2);
            document.getElementById('printTotalOnlineSummary').textContent = totalOnline.toFixed(2);
            document.getElementById('printTotalCreditSummary').textContent = totalCredit.toFixed(2);
            document.getElementById('printTotalPaymentAmount').textContent = totalPayment.toFixed(2);
            document.getElementById('printDifferenceAmount').textContent = difference.toFixed(2);
            
            // Show print section
            document.getElementById('printSection').style.display = 'block';
            
            // Immediately trigger print dialog
            setTimeout(() => {
                window.print();
                document.getElementById('printSection').style.display = 'none';
            }, 100);
        }

        function saveData() {
            const data = {
                transactions,
                cashDenominations,
                currentTransactionId,
                vouchers
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadData() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                const data = JSON.parse(savedData);
                transactions = data.transactions || [];
                cashDenominations = data.cashDenominations || [];
                currentTransactionId = data.currentTransactionId || 1;
                vouchers = data.vouchers || [];
                
                // Update displays
                updatePaymentSummary();
                updateVoucherSummary();
                updatePaymentReceivedDetails();
                updateCashDenominationSummary();
                updateTotals();
            }
        }
    </script>
</body>
</html>